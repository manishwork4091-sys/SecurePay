/**
 * Core Philosophy: This ruleset enforces a strict security model based on user ownership and role-based access control.
 * It ensures that users can only access their own data, while administrators have specific, elevated privileges for system-wide collections.
 *
 * Data Structure: User data is stored in `/users/{userId}`. Transactions are stored in a subcollection at `/users/{userId}/transactions/{transactionId}`
 * to enforce ownership at the path level. System-level data resides in separate top-level collections.
 *
 * Key Security Decisions:
 * - User Data Isolation: All collections under /users/{userId}, including transactions, are strictly private to the authenticated user matching that userId.
 * - Administrator Roles: Administrator status is determined by the existence of a document in the /roles_admin/{userId} collection. This collection is not client-accessible and must be managed via the Firebase console or a trusted backend.
 * - Immutable Audit Logs: The /auditLogs collection is read-only for administrators and cannot be written to by any client.
 *
 * Denormalization for Authorization: The /roles_admin/{userId} collection is a key example of denormalization. We perform a performant `exists()` check against this collection to determine admin privileges.
 *
 * Structural Segregation: User-private data (/users) is cleanly separated from system-level data (/auditLogs, /roles_admin).
 */
rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    //-------------------------------------------------------------------------
    // Helper Functions
    //-------------------------------------------------------------------------

    /**
     * isSignedIn
     * Checks if a user is authenticated.
     */
    function isSignedIn() {
      return request.auth != null;
    }

    /**
     * isOwner
     * Checks if the currently authenticated user's UID matches the provided userId.
     */
    function isOwner(userId) {
      return isSignedIn() && request.auth.uid == userId;
    }
    
    /**
     * isAdmin
     * Checks if the authenticated user has an admin role document.
     * This is a performant check that does not count as a read operation.
     */
    function isAdmin() {
      return isSignedIn() && exists(/databases/$(database)/documents/roles_admin/$(request.auth.uid));
    }

    /**
     * isCreatingOwnUserDocument
     * Validates that the user document being created has an 'id' field
     * that matches the user's auth UID.
     */
    function isCreatingOwnUserDocument(userId) {
      return request.resource.data.id == userId;
    }
    
    /**
     * isRoleImmutable
     * Ensures the role field cannot be changed by the user.
     */
    function isRoleImmutable() {
      return request.resource.data.role == resource.data.role;
    }


    //-------------------------------------------------------------------------
    // Collection Rules
    //-------------------------------------------------------------------------

    /**
     * @description   Stores user profiles and their associated subcollections.
     * @path          /users/{userId}
     */
    match /users/{userId} {
      // A user can create their own profile and can only read or write their own data thereafter. Role escalation is prevented.
      allow get: if isOwner(userId);
      allow list: if false; // Disallow listing all user profiles
      allow create: if isOwner(userId) && isCreatingOwnUserDocument(userId) && request.resource.data.role == 'user';
      allow update: if isOwner(userId) && isRoleImmutable();
      allow delete: if isOwner(userId);
      
      /**
       * @description   Stores transactions for the parent user. Access is inherited from the parent user document.
       * @path          /users/{userId}/transactions/{transactionId}
       */
      match /transactions/{transactionId} {
        allow read, write: if isOwner(userId);
      }
    }
    
    /**
     * @description   A collection used to grant admin privileges. The existence of a
     *                document with a user's UID as its ID means they are an admin.
     *                This collection is not readable or writable by any client.
     * @path          /roles_admin/{userId}
     */
    match /roles_admin/{userId} {
      allow read, write: if false;
    }

    /**
     * @description   Stores system-level audit logs. This data is created by backend
     *                processes and is read-only for administrators.
     * @path          /auditLogs/{auditLogId}
     */
    match /auditLogs/{auditLogId} {
      allow get, list: if isAdmin();
      allow create, update, delete: if false;
    }
  }
}
